"use strict";(globalThis["webpackChunkcom_smart_meter_reading"]=globalThis["webpackChunkcom_smart_meter_reading"]||[]).push([[476],{4476:(e,a,t)=>{t.r(a),t.d(a,{default:()=>J});t(310),t(2203),t(6724);var l=t(1758),n=t(8790),i=t(9104),s=t(8734),o=t(3394),r=t(4907);t(199);const c="http://localhost:8000/api/v1";async function u(e,a={}){const t=`${c}${e}`,l={headers:{"Content-Type":"application/json",Accept:"application/json"}},n=localStorage.getItem("auth_token");n&&(l.headers["Authorization"]=`Bearer ${n}`);const i={...l,...a,headers:{...l.headers,...a.headers}};try{const e=await fetch(t,i),a=await e.json();return e.ok?{success:!1!==a.success,data:a.data||a,error:null}:{success:!1,error:a.message||`HTTP error ${e.status}`,data:null}}catch(e){return console.error("API request failed:",e),{success:!1,error:e.message||"Network error",data:null}}}async function d(){return u("/setup/regions")}async function m(e){return u(`/setup/regions/${e}/tariffs`)}async function p(e){return u(`/setup/tariffs/${e}`)}async function v(e,a={}){const t=new URLSearchParams;void 0!==a.water_used&&t.append("water_used",a.water_used),void 0!==a.electricity_used&&t.append("electricity_used",a.electricity_used),void 0!==a.vat_rate&&t.append("vat_rate",a.vat_rate),void 0!==a.rates_rebate&&t.append("rates_rebate",a.rates_rebate);const l=t.toString(),n=`/setup/tariffs/${e}/preview-bill${l?"?"+l:""}`;return u(n)}async function f(){return u("/user-account/current")}async function g(e){return u("/user-account/create",{method:"POST",body:JSON.stringify(e)})}async function y(e){return u("/user-account/update",{method:"POST",body:JSON.stringify(e)})}async function b(){return u("/user-account/bill")}async function _(e,a){const t=await u("/user/login",{method:"POST",body:JSON.stringify({email:e,password:a})});return t.success&&t.data?.token&&localStorage.setItem("auth_token",t.data.token),t}async function w(){const e=await u("/user/logout",{method:"POST"});return localStorage.removeItem("auth_token"),e}function k(){return!!localStorage.getItem("auth_token")}function h(e){return Math.max(1,e-5)}const A={getRegions:d,getTariffsForRegion:m,getTariffDetails:p,previewBill:v,getCurrentAccount:f,createAccount:g,updateAccount:y,getCurrentBill:b,login:_,logout:w,isAuthenticated:k,calculateReadDay:h},E={class:"setup-container"},F={class:"header-section"},L={class:"page-title"},V={class:"preview-row"},q={class:"preview-row"},R={class:"preview-row"},D={class:"preview-row"},P={class:"preview-row"},I={class:"preview-row"},C={class:"preview-row total"},S={__name:"AccountSetupPage",setup(e){const a=(0,o.rd)(),t=(0,o.lq)(),c=(0,r.A)(),u=(0,s.KR)(!1),d=(0,s.KR)(!1),m=(0,s.KR)(!1),p=(0,s.KR)(!1),v=(0,s.KR)(""),f=(0,s.KR)(null),g=(0,s.KR)(!1),y=(0,l.EW)(()=>!!t.params.accountId),b=(0,s.KR)([]),_=(0,s.KR)([]),w=(0,s.KR)(null),k=(0,s.KR)(null),h=(0,s.KR)([]),S=(0,s.Kh)({regionId:null,tariffId:null,accountDescription:"",address:"",addressLat:null,addressLng:null,billingDay:20,readDay:15,waterEmail:"",electricityEmail:"",nameAsPerBill:""}),T=(0,l.EW)(()=>{const e=b.value.find(e=>e.id===S.regionId);if(!e)return!1;const a=e.name.toLowerCase();return a.includes("ethekwini")||a.includes("durban")}),B=(0,l.EW)(()=>b.value.map(e=>({label:e.name,value:e.id}))),K=(0,l.EW)(()=>_.value.map(e=>({label:e.template_name,value:e.id}))),U=Array.from({length:28},(e,a)=>({label:`${a+1}${x(a+1)} of each month`,value:a+1}));function x(e){if(e>=11&&e<=13)return"th";switch(e%10){case 1:return"st";case 2:return"nd";case 3:return"rd";default:return"th"}}async function Q(){d.value=!0;try{const e=await A.getRegions();e.success?b.value=e.data:(console.error("Failed to load regions:",e.error),b.value=[{id:1,name:"Durban (Ethekwini)",water_email:"water@durban.gov.za",electricity_email:"electricity@durban.gov.za"},{id:2,name:"Cape Town",water_email:"",electricity_email:""},{id:3,name:"Johannesburg",water_email:"",electricity_email:""}])}catch(e){console.error("Error loading regions:",e),b.value=[{id:1,name:"Durban (Ethekwini)",water_email:"water@durban.gov.za",electricity_email:"electricity@durban.gov.za"}]}finally{d.value=!1}}async function $(e){S.tariffId=null,_.value=[],w.value=null,k.value=null,h.value=[];const a=b.value.find(a=>a.id===e);a&&(T.value?(S.waterEmail=a.water_email||"water@durban.gov.za",S.electricityEmail=a.electricity_email||"electricity@durban.gov.za"):(S.waterEmail=a.water_email||"",S.electricityEmail=a.electricity_email||"")),e&&await O(e)}async function O(e){m.value=!0;try{const a=await A.getTariffsForRegion(e);a.success?_.value=a.data.tariffs||[]:(console.error("Failed to load tariffs:",a.error),_.value=[{id:10,template_name:"DurbanTariff",billing_day:20,read_day:15}])}catch(e){console.error("Error loading tariffs:",e),_.value=[]}finally{m.value=!1}}async function W(e){if(!e)return w.value=null,k.value=null,void(h.value=[]);await z(e)}async function z(e){p.value=!0;try{const a=await A.getTariffDetails(e);a.success&&(w.value=a.data,S.billingDay=a.data.billing_day||20,S.readDay=a.data.calculated_read_day||15,h.value=(a.data.customer_costs||[]).map(e=>({title:e.title||e.description||"",value:e.value||e.amount||0})),await G(e))}catch(e){console.error("Error loading tariff details:",e)}finally{p.value=!1}}async function G(e){try{const a=await A.previewBill(e,{customer_costs:h.value});a.success&&(k.value=a.data)}catch(e){console.error("Error loading bill preview:",e)}}function X(e){S.readDay=A.calculateReadDay(e)}async function N(){if(g.value)return;if("undefined"===typeof google||!google.maps||!google.maps.places){const e=process.env.GOOGLE_PLACES_API_KEY||process.env.VUE_APP_GOOGLE_PLACES_API_KEY;if(!e)return void console.warn("Google Places API key not configured. Address autocomplete disabled.");await j(e)}await(0,l.dY)();const e=f.value?.$el?.querySelector("input");if(e)try{const a=new google.maps.places.Autocomplete(e,{componentRestrictions:{country:"za"},fields:["formatted_address","geometry","address_components"]});a.addListener("place_changed",()=>{const e=a.getPlace();e.formatted_address&&(S.address=e.formatted_address),e.geometry?.location&&(S.addressLat=e.geometry.location.lat(),S.addressLng=e.geometry.location.lng())}),g.value=!0}catch(e){console.error("Failed to initialize Google Places:",e)}}function j(e){return new Promise((a,t)=>{if("undefined"!==typeof google&&google.maps)return void a();const l=document.createElement("script");l.src=`https://maps.googleapis.com/maps/api/js?key=${e}&libraries=places`,l.async=!0,l.defer=!0,l.onload=a,l.onerror=t,document.head.appendChild(l)})}async function J(){c.notify({type:"info",message:"Edit mode - loading account data...",position:"top"})}async function M(){if(v.value="",S.regionId&&S.tariffId)if(S.accountDescription&&S.address)if(S.billingDay)if(S.nameAsPerBill){u.value=!0;try{const e={tariff_template_id:S.tariffId,account_name:S.accountDescription,name_as_per_bill:S.nameAsPerBill,billing_day:S.billingDay,site_title:S.accountDescription,site_address:S.address,address_lat:S.addressLat,address_lng:S.addressLng,water_email:S.waterEmail,electricity_email:S.electricityEmail,customer_costs:h.value},l=y.value?await A.updateAccount({account_id:t.params.accountId,...e}):await A.createAccount(e);l.success?(c.notify({type:"positive",message:y.value?"Account updated successfully!":"Account created successfully!",position:"top"}),a.push({name:"home"})):v.value=l.error||"Failed to save account"}catch(e){console.error("Error saving account:",e),v.value=e.message||"An error occurred while saving"}finally{u.value=!1}}else v.value="Please enter the name as it appears on your bill";else v.value="Please select a billing day";else v.value="Please fill in account description and address";else v.value="Please select a region and tariff template"}function Y(){window.history.length>1?a.back():a.push({name:"login"})}return(0,l.sV)(async()=>{await Q(),y.value&&await J()}),(0,l.wB)(h,async()=>{S.tariffId&&await G(S.tariffId)},{deep:!0}),(e,a)=>{const t=(0,l.g2)("q-btn"),o=(0,l.g2)("q-banner"),r=(0,l.g2)("q-icon"),c=(0,l.g2)("q-select"),p=(0,l.g2)("q-input"),g=(0,l.g2)("q-separator"),b=(0,l.g2)("q-card-section"),_=(0,l.g2)("q-card"),w=(0,l.g2)("q-form"),A=(0,l.g2)("q-page");return(0,l.uX)(),(0,l.Wv)(A,{class:"account-setup-page"},{default:(0,l.k6)(()=>[(0,l.Lk)("div",E,[(0,l.Lk)("div",F,[(0,l.bF)(t,{flat:"",round:"",icon:"arrow_back",color:"white",onClick:Y,"data-test":"setup-back"}),(0,l.Lk)("h1",L,(0,n.v_)(y.value?"Edit Account":"Account Setup"),1),a[10]||(a[10]=(0,l.Lk)("div",{style:{width:"40px"}},null,-1))]),(0,l.bF)(_,{class:"setup-card"},{default:(0,l.k6)(()=>[(0,l.bF)(b,null,{default:(0,l.k6)(()=>[v.value?((0,l.uX)(),(0,l.Wv)(o,{key:0,class:"bg-negative text-white q-mb-md",rounded:"","data-test":"setup-error"},{default:(0,l.k6)(()=>[(0,l.eW)((0,n.v_)(v.value),1)]),_:1})):(0,l.Q3)("",!0),(0,l.bF)(w,{onSubmit:(0,i.D$)(M,["prevent"]),class:"setup-form"},{default:(0,l.k6)(()=>[a[19]||(a[19]=(0,l.Lk)("div",{class:"section-title"},"Region & Tariff",-1)),(0,l.bF)(c,{modelValue:S.regionId,"onUpdate:modelValue":[a[0]||(a[0]=e=>S.regionId=e),$],options:B.value,label:"Region *",outlined:"","emit-value":"","map-options":"",loading:d.value,rules:[e=>!!e||"Region is required"],"data-test":"setup-region",class:"q-mb-md"},{prepend:(0,l.k6)(()=>[(0,l.bF)(r,{name:"location_city"})]),_:1},8,["modelValue","options","loading","rules"]),(0,l.bF)(c,{modelValue:S.tariffId,"onUpdate:modelValue":[a[1]||(a[1]=e=>S.tariffId=e),W],options:K.value,label:"Tariff Template *",outlined:"","emit-value":"","map-options":"",loading:m.value,disable:!S.regionId,rules:[e=>!!e||"Tariff template is required"],"data-test":"setup-tariff",class:"q-mb-md"},{prepend:(0,l.k6)(()=>[(0,l.bF)(r,{name:"receipt_long"})]),_:1},8,["modelValue","options","loading","disable","rules"]),a[20]||(a[20]=(0,l.Lk)("div",{class:"section-title"},"Account Details",-1)),(0,l.bF)(p,{modelValue:S.accountDescription,"onUpdate:modelValue":a[2]||(a[2]=e=>S.accountDescription=e),label:"Account Description *",outlined:"",hint:"E.g., Main House, Granny Flat, Shop",rules:[e=>!!e||"Account description is required"],"data-test":"setup-account-description",class:"q-mb-md"},{prepend:(0,l.k6)(()=>[(0,l.bF)(r,{name:"home"})]),_:1},8,["modelValue","rules"]),(0,l.bF)(p,{modelValue:S.address,"onUpdate:modelValue":a[4]||(a[4]=e=>S.address=e),label:"Address *",outlined:"",ref_key:"addressInput",ref:f,rules:[e=>!!e||"Address is required"],"data-test":"setup-address",class:"q-mb-md",onFocus:N},{prepend:(0,l.k6)(()=>[(0,l.bF)(r,{name:"place"})]),append:(0,l.k6)(()=>[S.address?((0,l.uX)(),(0,l.Wv)(r,{key:0,name:"close",class:"cursor-pointer",onClick:a[3]||(a[3]=e=>S.address="")})):(0,l.Q3)("",!0)]),_:1},8,["modelValue","rules"]),a[21]||(a[21]=(0,l.Lk)("div",{class:"section-title"},"Billing Schedule",-1)),(0,l.bF)(c,{modelValue:S.billingDay,"onUpdate:modelValue":[a[5]||(a[5]=e=>S.billingDay=e),X],options:(0,s.R1)(U),label:"Billing Day *",outlined:"","emit-value":"","map-options":"",rules:[e=>!!e||"Billing day is required"],"data-test":"setup-billing-day",class:"q-mb-md"},{prepend:(0,l.k6)(()=>[(0,l.bF)(r,{name:"event"})]),_:1},8,["modelValue","options","rules"]),(0,l.bF)(p,{modelValue:S.readDay,"onUpdate:modelValue":a[6]||(a[6]=e=>S.readDay=e),label:"Read Day (Auto-calculated)",outlined:"",readonly:"",disable:"",hint:"Automatically set to 5 days before billing day","data-test":"setup-read-day",class:"q-mb-md"},{prepend:(0,l.k6)(()=>[(0,l.bF)(r,{name:"schedule"})]),_:1},8,["modelValue"]),a[22]||(a[22]=(0,l.Lk)("div",{class:"section-title"},"Contact Emails",-1)),(0,l.bF)(p,{modelValue:S.waterEmail,"onUpdate:modelValue":a[7]||(a[7]=e=>S.waterEmail=e),type:"email",label:"Water Department Email",outlined:"",hint:T.value?"Auto-filled for Ethekwini region":"Email for water queries","data-test":"setup-water-email",class:"q-mb-md"},{prepend:(0,l.k6)(()=>[(0,l.bF)(r,{name:"water_drop",color:"blue"})]),_:1},8,["modelValue","hint"]),(0,l.bF)(p,{modelValue:S.electricityEmail,"onUpdate:modelValue":a[8]||(a[8]=e=>S.electricityEmail=e),type:"email",label:"Electricity Department Email",outlined:"",hint:T.value?"Auto-filled for Ethekwini region":"Email for electricity queries","data-test":"setup-electricity-email",class:"q-mb-md"},{prepend:(0,l.k6)(()=>[(0,l.bF)(r,{name:"bolt",color:"amber"})]),_:1},8,["modelValue","hint"]),h.value.length>0?((0,l.uX)(),(0,l.CE)(l.FK,{key:0},[a[11]||(a[11]=(0,l.Lk)("div",{class:"section-title"},[(0,l.eW)(" Customer Costs "),(0,l.Lk)("span",{class:"section-hint"},"(Editable - changes won't affect past bills)")],-1)),((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(h.value,(e,a)=>((0,l.uX)(),(0,l.CE)("div",{key:a,class:"cost-item q-mb-sm"},[(0,l.bF)(p,{modelValue:e.title,"onUpdate:modelValue":a=>e.title=a,label:"Description",outlined:"",dense:"",class:"cost-title","data-test":"setup-cost-title"},null,8,["modelValue","onUpdate:modelValue"]),(0,l.bF)(p,{modelValue:e.value,"onUpdate:modelValue":a=>e.value=a,modelModifiers:{number:!0},type:"number",prefix:"R",label:"Amount",outlined:"",dense:"",class:"cost-value","data-test":"setup-cost-value"},null,8,["modelValue","onUpdate:modelValue"])]))),128))],64)):(0,l.Q3)("",!0),a[23]||(a[23]=(0,l.Lk)("div",{class:"section-title"},"Bill Details",-1)),(0,l.bF)(p,{modelValue:S.nameAsPerBill,"onUpdate:modelValue":a[9]||(a[9]=e=>S.nameAsPerBill=e),label:"Name as per Bill *",outlined:"",hint:"Enter the name exactly as it appears on your utility bill",rules:[e=>!!e||"Name as per bill is required"],"data-test":"setup-name-as-per-bill",class:"q-mb-md"},{prepend:(0,l.k6)(()=>[(0,l.bF)(r,{name:"badge"})]),_:1},8,["modelValue","rules"]),k.value?((0,l.uX)(),(0,l.CE)(l.FK,{key:1},[a[18]||(a[18]=(0,l.Lk)("div",{class:"section-title"},"Bill Preview",-1)),(0,l.bF)(_,{flat:"",bordered:"",class:"bill-preview q-mb-md"},{default:(0,l.k6)(()=>[(0,l.bF)(b,null,{default:(0,l.k6)(()=>[(0,l.Lk)("div",V,[a[12]||(a[12]=(0,l.Lk)("span",null,"Water:",-1)),(0,l.Lk)("span",null,"R"+(0,n.v_)(k.value.water?.total?.toFixed(2)||"0.00"),1)]),(0,l.Lk)("div",q,[a[13]||(a[13]=(0,l.Lk)("span",null,"Electricity:",-1)),(0,l.Lk)("span",null,"R"+(0,n.v_)(k.value.electricity?.total?.toFixed(2)||"0.00"),1)]),(0,l.Lk)("div",R,[a[14]||(a[14]=(0,l.Lk)("span",null,"Fixed Costs:",-1)),(0,l.Lk)("span",null,"R"+(0,n.v_)(k.value.fixed_costs?.total?.toFixed(2)||"0.00"),1)]),(0,l.Lk)("div",D,[a[15]||(a[15]=(0,l.Lk)("span",null,"Customer Costs:",-1)),(0,l.Lk)("span",null,"R"+(0,n.v_)(k.value.customer_costs?.total?.toFixed(2)||"0.00"),1)]),(0,l.Lk)("div",P,[(0,l.Lk)("span",null,"VAT ("+(0,n.v_)(k.value.vat?.percentage||15)+"%):",1),(0,l.Lk)("span",null,"R"+(0,n.v_)(k.value.vat?.amount?.toFixed(2)||"0.00"),1)]),(0,l.Lk)("div",I,[a[16]||(a[16]=(0,l.Lk)("span",null,"Rates:",-1)),(0,l.Lk)("span",null,"R"+(0,n.v_)(k.value.rates?.net?.toFixed(2)||"0.00"),1)]),(0,l.bF)(g,{class:"q-my-sm"}),(0,l.Lk)("div",C,[a[17]||(a[17]=(0,l.Lk)("span",null,"Estimated Total:",-1)),(0,l.Lk)("span",null,"R"+(0,n.v_)(k.value.total?.toFixed(2)||"0.00"),1)])]),_:1})]),_:1})],64)):(0,l.Q3)("",!0),(0,l.bF)(t,{type:"submit",color:"primary",label:y.value?"Save Changes":"Create Account",class:"full-width q-mb-md",loading:u.value,"data-test":"setup-submit"},null,8,["label","loading"]),(0,l.bF)(t,{flat:"",color:"grey",label:"Cancel",class:"full-width",onClick:Y,"data-test":"setup-cancel"})]),_:1})]),_:1})]),_:1})])]),_:1})}}};var T=t(2807),B=t(7716),K=t(6384),U=t(3316),x=t(4189),Q=t(6868),$=t(9200),O=t(1033),W=t(492),z=t(9270),G=t(386),X=t(8582),N=t.n(X);const j=(0,T.A)(S,[["__scopeId","data-v-42543b1a"]]),J=j;N()(S,"components",{QPage:B.A,QBtn:K.A,QCard:U.A,QCardSection:x.A,QBanner:Q.A,QForm:$.A,QSelect:O.A,QIcon:W.A,QInput:z.A,QSeparator:G.A})}}]);